# SPDX-FileCopyrightText: 2025 Nextcloud GmbH and Nextcloud contributors
# SPDX-License-Identifier: MIT

name: E2E tests
on: pull_request

permissions:
  contents: read

jobs:
  matrix:
    runs-on: ubuntu-latest-low
    outputs:
      php-min: ${{ steps.versions.outputs.php-min }}
      branches-min: ${{ steps.versions.outputs.branches-min }}
    steps:
      - name: Checkout app
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Get version matrix
        id: versions
        uses: icewind1991/nextcloud-version-matrix@58becf3b4bb6dc6cef677b15e2fd8e7d48c0908f # v1.3.1

  frontend-e2e-tests:
    runs-on: ubuntu-latest
    name: Front-end E2E tests
    needs: matrix
    steps:
      - name: Set up Nextcloud env
        uses: ChristophWurst/setup-nextcloud@fc0790385c175d97e88a7cb0933490de6e990374 # v0.3.2
        with:
          nextcloud-version: ${{ needs.matrix.outputs.branches-min }}
          php-version: ${{ needs.matrix.outputs.php-min }}
          install: true
      - name: Configure Nextcloud for testing
        run: |
          php -f nextcloud/occ config:system:set debug --type=bool --value=true
          php -f nextcloud/occ config:system:set overwriteprotocol --value=https
          php -f nextcloud/occ config:system:set overwritehost --value=localhost
          php -f nextcloud/occ config:system:set overwrite.cli.url --value=https://localhost
      - name: Check out the app
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          path: nextcloud/apps/calendar
      - name: Read package.json node and npm engines version
        uses: skjnldsv/read-package-engines-version-actions@06d6baf7d8f41934ab630e97d9e6c0bc9c9ac5e4 # v3
        id: package-engines-versions
        with:
          fallbackNode: '^24'
          fallbackNpm: '^11'
          path: nextcloud/apps/calendar
      - name: Set up node ${{ steps.package-engines-versions.outputs.nodeVersion }}
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: ${{ steps.package-engines-versions.outputs.nodeVersion }}
      - name: Set up npm ${{ steps.package-engines-versions.outputs.npmVersion }}
        run: npm i -g 'npm@${{ steps.package-engines-versions.outputs.npmVersion }}'
      - name: Install php dependencies
        working-directory: nextcloud/apps/calendar
        run: composer install
      - name: Install the app
        run: php -f nextcloud/occ app:enable calendar
      - name: Install npm dependencies
        working-directory: nextcloud/apps/calendar
        run: npm ci
      - name: Build frontend
        working-directory: nextcloud/apps/calendar
        run: npm run build
      - name: Install stunnel (tiny https proxy)
        run: sudo apt-get update && sudo apt-get install -y stunnel
      - name: Start php server and https proxy
        working-directory: nextcloud
        run: |
          openssl req -new -x509 -days 365 -nodes -subj "/C=US/ST=Denial/L=Springfield/O=Dis/CN=localhost" -out stunnel.pem -keyout stunnel.pem
          php -S 127.0.0.1:8080 &
          sudo stunnel3 -p stunnel.pem -d 443 -r 8080
      - name: Test https access
        run: curl --insecure -Li https://localhost
      - name: Install Playwright browsers
        working-directory: nextcloud/apps/calendar
        run: npx playwright install --with-deps chromium
      - name: Run Playwright tests
        working-directory: nextcloud/apps/calendar
        run: DEBUG=pw:api npx playwright test
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        if: always()
        with:
          name: playwright-report-${{ github.event.number }}-nc${{ needs.matrix.outputs.branches-min }}-php${{ needs.matrix.outputs.php-min }}-node${{ steps.package-engines-versions.outputs.nodeVersion }}
          path: nextcloud/apps/calendar/playwright-report/
          retention-days: 14
      - name: Print server logs
        if: always()
        run: cat nextcloud/data/nextcloud.log*
    env:
      CI: true
